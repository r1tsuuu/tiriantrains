{% extends "layouts/base.html" %} 
{% block title %} Book Tickets {% endblock %}

{% block stylesheets %}
<style>
  /* Custom styling to make the entire card act as a clickable button */
  .trip-card { 
    transition: all 0.2s ease-in-out; 
    border: 2px solid transparent; 
  }
  .trip-card:hover { 
    border-color: #cbd5e1; 
    box-shadow: 0 .125rem .25rem rgba(0,0,0,.075) !important; 
  }
  /* Highlights the card blue when the hidden checkbox inside it is checked */
  .trip-card:has(input:checked) { 
    border-color: #3b7ddd; 
    background-color: #f8fbff; 
  } 
  .form-check-input.large-checkbox { 
    width: 1.5em; 
    height: 1.5em; 
    cursor: pointer; 
  }
  .cursor-pointer { 
    cursor: pointer; 
  }
</style>
{% endblock stylesheets %}

{% block content %}
<main class="content">
  <div class="container-fluid p-0">
    
    <div class="row mb-2 mb-xl-3">
      <div class="col-auto d-none d-sm-block">
        <h1 class="h3 mb-3">Book Your Trip</h1>
      </div>

      <div class="col-12">
        {% if msg %} 
          {% if success %}
          <div class="alert alert-success alert-dismissible shadow-sm" role="alert">
            <div class="alert-message">
              <h4 class="alert-heading fw-bold"><i class="align-middle me-2" data-feather="check-circle"></i>Success!</h4>
              <p>{{ msg }}</p>
              <hr />
              <p class="mb-0">
                Check your <a href="{% url 'ticket_summary' %}" class="alert-link">Ticket Summary</a> to view details.
              </p>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
          {% else %}
          <div class="alert alert-danger alert-dismissible shadow-sm" role="alert">
            <div class="alert-message"><strong>Error:</strong> {{ msg }}</div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
          {% endif %} 
        {% endif %}
      </div>
    </div>

    <form method="post" action="">
      {% csrf_token %}
      
      <div class="row">
        <div class="col-md-4 col-xl-3">
          <div class="card shadow-sm sticky-top" style="top: 20px; z-index: 1">
            <div class="card-header bg-light">
              <h5 class="card-title mb-0"><i class="align-middle me-2" data-feather="calendar"></i>Ticket Details</h5>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label fw-bold">Select Ticket Date</label>
                {{ form.trip_date }}
                <small class="form-text text-muted">Intended date of purchase/travel.</small>
                <div class="text-danger small mt-1">{{ form.trip_date.errors }}</div>
              </div>

              <hr>

              <div class="d-grid gap-2 mt-3">
                <button type="submit" class="btn btn-primary btn-lg">
                  Confirm Purchase
                </button>
                <a href="{% url 'home' %}" class="btn btn-outline-secondary">Cancel</a>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-8 col-xl-9">
          <div class="card shadow-sm">
            <div class="card-header bg-light">
              <h5 class="card-title mb-0"><i class="align-middle me-2" data-feather="map"></i>Select Available Trips</h5>
            </div>
            <div class="card-body bg-light pt-0">
              <div class="text-danger small mb-3">{{ form.trips.errors }}</div>

              {% regroup trips by schedule_day as trips_by_date %}
              
              {% for date_group in trips_by_date %}
                <h5 class="text-uppercase text-muted fw-bold mb-3 mt-4 border-bottom pb-2">
                  <i class="align-middle me-2" data-feather="calendar"></i>{{ date_group.grouper|date:"l, F j, Y" }}
                </h5>
                
                <div class="row">
                  {% for trip in date_group.list %}
                  <div class="col-12 mb-2">
                    
                    <label class="card shadow-sm trip-card cursor-pointer w-100 text-start m-0" for="trip_{{ trip.trip_id }}">
                      <div class="card-body p-3">
                        <div class="row align-items-center">
                          
                          <div class="col-auto">
                            <input class="form-check-input large-checkbox mt-0" type="checkbox" name="trips" value="{{ trip.trip_id }}" id="trip_{{ trip.trip_id }}"
                             {% if form.trips.value and trip.trip_id in form.trips.value %}checked{% endif %}>
                          </div>
                          
                          <div class="col">
                             <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5 class="mb-1 fw-bold text-dark">
                                        {{ trip.origin_name }} 
                                        <i class="align-middle text-muted mx-1" data-feather="arrow-right"></i> 
                                        {{ trip.destination_name }}
                                    </h5>
                                    <div class="text-muted small mb-2">
                                        <i class="align-middle" data-feather="clock"></i> 
                                        <span class="fw-semibold text-dark">{{ trip.departure_time|time:"g:i A" }}</span> 
                                        - 
                                        <span class="fw-semibold text-dark">{{ trip.arrival_time|time:"g:i A" }}</span>
                                        <span class="mx-2">&bull;</span>
                                        <i class="align-middle" data-feather="navigation"></i> {{ trip.formatted_duration }}
                                     </div>
                                </div>
                                
                                <div class="text-end">
                                    <div class="fs-4 fw-bold text-success">ðŸª™ {{ trip.trip_cost }}</div>
                                </div>
                             </div>
                             
                             <div>
                                <span class="badge {% if trip.trip_type == 'L' %}bg-info{% else %}bg-primary{% endif %} me-1">
                                    {{ trip.get_trip_type_display }}
                                </span>
                                <span class="badge bg-secondary">
                                    <i class="align-middle" style="width: 12px; height: 12px;" data-feather="train"></i> 
                                    Train {{ trip.train.train_number }}
                                </span>
                             </div>
                          </div>
                          
                        </div>
                      </div>
                    </label>

                  </div>
                  {% endfor %}
                </div>
              
              {% empty %}
                <div class="text-center py-5">
                  <div class="display-4 text-muted mb-3"><i class="align-middle" data-feather="map-pin"></i></div>
                  <h4 class="text-muted">No trips available to book.</h4>
                  <p class="text-muted">Check back later for new schedules.</p>
                </div>
              {% endfor %}

            </div>
          </div>
        </div>
      </div>
    </form>
    
  </div>
</main>
{% endblock content %}